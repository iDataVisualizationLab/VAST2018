<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test parallel coordinates</title>
    <style>
        @import "lib/d3.parsets.css";
    </style>
    <script src="lib/d3.js"></script>
    <script>
        var d3version4 = d3;
        window.d3 = null;
    </script>
    <script src="lib/d3.v2.js"></script>
    <script src="lib/d3.parsets.js"></script>
    <script src="lib/plotly.js"></script>
</head>
<body>
<div id="graphDiv"></div>
<script>
    Plotly.d3.csv("mc2/Boonsong Lekagul waterways readings.csv", (error, rows)=>{
        var d3 = d3version4;
        if(error) throw  error;
        function unpack(rows, column){
            return rows.map(row=>row[column]);
        }
        //Process location
        let locationColumn = unpack(rows, 'location');
        let uniqueLocations = d3.set(locationColumn).values();
        uniqueLocations.sort((a, b)=>a.localeCompare(b));
        function locationToIndex(loc){
            return uniqueLocations.indexOf(loc);
        }
        //Process sample dates
        let sampleDateColumn = unpack(rows, 'sample date');
        //Process sample years
        let sampleYears = sampleDateColumn.map(d=>(new Date(d)).getFullYear());
        let uniqueYears = d3.set(sampleYears).values();
        uniqueYears.sort((a, b) => a-b);

        //Process measures
        let measureColumn = unpack(rows, 'measure');
        let uniqueMeasures = d3.set(measureColumn).values();
        uniqueMeasures.sort((a, b)=> a.localeCompare(b));
        function measureToIndex(measure){
            return uniqueMeasures.indexOf(measure);
        }
        //Process the value column
        let valueColumn = unpack(rows, 'value');
        //Color
        let c10 = d3.schemeCategory10;
        let colorscale = [];
        uniqueLocations.map((d, i)=>{
            colorscale.push([i, c10[i]]);
        });

        let data = [{
            type: 'parcoords',
            line:{
                color: locationColumn.map(loc=>locationToIndex(loc)),
                colorscale: colorscale
            },
            dimensions: [
                {
                    label: 'Location',
                    values: locationColumn.map(loc=>locationToIndex(loc)),
                    tickvals: uniqueLocations.map((d, i) => i),
                    ticktext: uniqueLocations
                },{
                    label: 'Mesure',
                    values: measureColumn.map(measure=>measureToIndex(measure)),
                    tickvals: uniqueMeasures.map((d, i) => i),
                    ticktext: uniqueMeasures
                },{
                    label: 'Sample year',
                    values: sampleYears,
                    tickvals: uniqueYears,
                    ticktext: uniqueYears.map(y=>y+"")
                },{
                    label: 'Log10(value)',
                    values: valueColumn.map(value=>Math.log10(value))
                },{
                    label: 'Value',
                    values: valueColumn
                }
            ]
        }];
        let layout = {
            height: 1600
        }
        Plotly.plot('graphDiv', data, layout);
    });

</script>
<div id="vis" style="width: 1200px;"></div>
<script>
    var chart = d3.parsets().dimensions(["location","measure","sample date"]);
    var vis = d3.select("#vis").append("svg")
        .attr("width", chart.width())
        .attr("height", chart.height());
    d3.csv("mc2/Boonsong Lekagul waterways readings.csv", (csv)=>{
        vis.datum(csv).call(chart);
    });
</script>
</body>
</html>